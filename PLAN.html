<!-- BEGIN pace_go_plan.html -->
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>Implementing PACE in Go – Romanian eID (CEI)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      line-height: 1.6;
      margin: 40px;
      color: #222;
    }

    h1,
    h2,
    h3,
    h4 {
      line-height: 1.3;
    }

    h1 {
      font-size: 2.2em;
    }

    h2 {
      font-size: 1.6em;
      margin-top: 2em;
    }

    h3 {
      font-size: 1.25em;
      margin-top: 1.5em;
    }

    code,
    pre {
      background: #f6f8fa;
      border-radius: 4px;
    }

    pre {
      padding: 12px;
      overflow-x: auto;
    }

    code {
      padding: 2px 4px;
    }

    hr {
      margin: 2.5em 0;
    }

    ul {
      margin-left: 1.5em;
    }

    table {
      border-collapse: collapse;
      margin: 1em 0;
    }

    th,
    td {
      border: 1px solid #ccc;
      padding: 8px 12px;
    }

    blockquote {
      border-left: 4px solid #ccc;
      padding-left: 12px;
      color: #555;
    }

    @media print {
      body {
        margin: 20mm;
      }
    }
  </style>
</head>

<body>

  <h1>Implementing PACE in Go</h1>
  <h2>A Practical Engineering Plan for Romanian Electronic ID (CEI)</h2>

  <hr />

  <h2>0. Reality Check (Scope & Difficulty)</h2>

  <p>PACE (Password Authenticated Connection Establishment) is:</p>
  <ul>
    <li>A mandatory cryptographic protocol for accessing Romanian CEI data</li>
    <li>Defined across multiple international specifications</li>
    <li>Based on ECC, AES, CMAC, KDFs, and Secure Messaging</li>
    <li>Tightly coupled to ISO/IEC 7816 smart-card APDU exchange</li>
  </ul>

  <p><strong>Estimated effort:</strong></p>
  <ul>
    <li>4–8 weeks for a minimal, working implementation by an experienced engineer</li>
  </ul>

  <p>This is protocol-level cryptographic engineering, not a simple integration task.</p>

  <hr />

  <h2>1. Knowledge Required</h2>

  <h3>1.1 Smart Cards / ISO 7816</h3>

  <ul>
    <li>APDU structure (CLA, INS, P1, P2, Lc, Le)</li>
    <li>File system concepts (MF, DF, EF)</li>
    <li>SELECT by AID</li>
    <li>Status words (e.g. 9000, 6982)</li>
    <li>T=0 and T=1 protocols</li>
    <li>Secure Messaging concepts</li>
  </ul>

  <p><strong>Relevant standards:</strong></p>
  <ul>
    <li>ISO/IEC 7816-4</li>
    <li>ISO/IEC 7816-8</li>
    <li>ISO/IEC 7816-9</li>
  </ul>

  <h3>1.2 Cryptography (Mandatory)</h3>

  <ul>
    <li>AES-128 / AES-256</li>
    <li>AES-CMAC</li>
    <li>Elliptic Curve Cryptography</li>
    <li>Diffie-Hellman / ECDH</li>
    <li>BrainpoolP256r1 (commonly used by EU eID cards)</li>
    <li>Key derivation functions</li>
    <li>Nonces and challenge-response protocols</li>
  </ul>

  <p><strong>Relevant documents:</strong></p>
  <ul>
    <li>NIST SP 800-38B (CMAC)</li>
    <li>BSI TR-03110 (PACE specification)</li>
    <li>ICAO 9303 (background)</li>
  </ul>

  <h3>1.3 PACE Protocol Internals</h3>

  <ul>
    <li>PACE phases</li>
    <li>Mapping types (GM, IM)</li>
    <li>Password types (PIN, CAN, MRZ)</li>
    <li>Mutual authentication</li>
    <li>Transition from plaintext APDUs to Secure Messaging</li>
  </ul>

  <h3>1.4 Go-Specific Knowledge</h3>

  <ul>
    <li><code>crypto/aes</code></li>
    <li><code>crypto/cipher</code></li>
    <li><code>crypto/elliptic</code> (incomplete curve support)</li>
    <li><code>golang.org/x/crypto</code></li>
    <li><code>math/big</code></li>
    <li>Byte-level protocol handling</li>
  </ul>

  <hr />

  <h2>2. Prerequisites</h2>

  <h3>2.1 Hardware</h3>
  <ul>
    <li>Romanian Electronic Identity Card (CEI)</li>
    <li>PC/SC-compatible smart-card reader (ACS, Omnikey, Identiv)</li>
  </ul>

  <h3>2.2 Software</h3>
  <ul>
    <li>pcscd running (Linux) or Smart Card service (Windows/macOS)</li>
    <li>Go 1.20 or newer</li>
  </ul>

  <h3>2.3 Go Libraries</h3>
  <ul>
    <li><code>github.com/ebfe/scard</code> (PC/SC access)</li>
    <li><code>golang.org/x/crypto</code> (CMAC, helpers)</li>
  </ul>

  <p><strong>Note:</strong> Brainpool curves are not fully supported by Go’s standard library.
    You must implement or port them.</p>

  <hr />

  <h2>3. High-Level Architecture</h2>

  <pre>
Go Application
 ├─ PACE Layer
 │   ├─ Password Processing
 │   ├─ Mapping Phase
 │   ├─ Key Agreement
 │   └─ Secure Messaging Setup
 ├─ APDU Layer
 │   ├─ SELECT
 │   └─ GENERAL AUTHENTICATE
 └─ PC/SC Transport
</pre>

  <hr />

  <h2>4. Step-by-Step Implementation Plan</h2>

  <h3>Step 1 — PC/SC Transport and Raw APDU Layer</h3>

  <ul>
    <li>Reader enumeration</li>
    <li>Card connection</li>
    <li>APDU transmit wrapper</li>
    <li>Full APDU logging</li>
  </ul>

  <pre><code>type Card interface {
    Transmit(apdu []byte) ([]byte, error)
}</code></pre>

  <h3>Step 2 — Application Selection and Capability Discovery</h3>

  <ul>
    <li>SELECT CEI application by AID</li>
    <li>Parse FCI</li>
    <li>Identify supported PACE algorithms</li>
  </ul>

  <pre><code>type PaceInfo struct {
    OID    string
    Curve  string
    Cipher string
}</code></pre>

  <h3>Step 3 — Password to Key Material (K_pi)</h3>

  <ul>
    <li>Encode PIN or CAN</li>
    <li>Derive K_pi using SHA-1 or SHA-256</li>
  </ul>

  <p>K_pi is never sent to the card.</p>

  <h3>Step 4 — PACE Mapping Phase (Hardest Part)</h3>

  <ul>
    <li>Card sends encrypted nonce</li>
    <li>Terminal decrypts nonce using K_pi</li>
    <li>Nonce mapped to EC domain parameters</li>
    <li>Mapped public key sent to card</li>
  </ul>

  <h3>Step 5 — Ephemeral Key Agreement (ECDH)</h3>

  <ul>
    <li>Generate ephemeral EC key pair</li>
    <li>Exchange public keys via GENERAL AUTHENTICATE</li>
    <li>Compute shared secret Z</li>
  </ul>

  <h3>Step 6 — Session Key Derivation</h3>

  <table>
    <tr>
      <th>Key</th>
      <th>Purpose</th>
    </tr>
    <tr>
      <td>K_enc</td>
      <td>Encryption</td>
    </tr>
    <tr>
      <td>K_mac</td>
      <td>MAC</td>
    </tr>
  </table>

  <p>Derived from Z using the TR-03110 KDF.</p>

  <h3>Step 7 — Mutual Authentication</h3>

  <p>Both sides prove possession of session keys.
    Failure indicates wrong PIN/CAN or crypto error.</p>

  <h3>Step 8 — Secure Messaging Layer</h3>

  <ul>
    <li>Encrypt APDUs</li>
    <li>Apply AES-CMAC</li>
    <li>Maintain Send Sequence Counter (SSC)</li>
  </ul>

  <h3>Step 9 — Reading Identity Data</h3>

  <ul>
    <li>SELECT EF files</li>
    <li>READ BINARY</li>
    <li>Parse ASN.1 / TLV data</li>
  </ul>

  <hr />

  <h2>5. Testing Strategy</h2>

  <ul>
    <li>pcscd debug mode</li>
    <li>Extensive APDU logging</li>
    <li>Comparison with JMRTD / official middleware</li>
  </ul>

  <hr />

  <h2>6. Final Outcome</h2>

  <ul>
    <li>Native Go PACE implementation</li>
    <li>PIN-protected CEI access</li>
    <li>Secure Messaging channel</li>
    <li>Foundation for authentication and signing</li>
  </ul>

  <hr />

  <h2>7. Strong Recommendation</h2>

  <blockquote>
    <p><strong>For speed and reliability:</strong><br />
      Implement everything except PACE in Go and delegate PACE to JMRTD (Java).</p>

    <p><strong>For full control and long-term ownership:</strong><br />
      Implement PACE fully in Go using this plan.</p>
  </blockquote>

</body>

</html>
<!-- END pace_go_plan.html -->
